# UISP Migration — Data Import Implementation Guide

**Date:** February 10-11, 2026
**Project:** Imperial Networks UISP Migration (McBroad → On-Premise)
**Deadline:** February 15, 2026

---

## Overview

This document explains how data was migrated from the old UISP (hosted by McBroad at `uisp.imperial-networks.com`) to the new on-premise UISP (`10.255.255.86`). Since the previous developer did not provide a database dump, all data was extracted via the UISP REST API and re-imported.

---

## What Was Migrated

| Data | Count | Method | Status |
|------|-------|--------|--------|
| **Clients** | 9,826 imported (45 failed) | CSV export → Python script | Completed |
| **Invoices** | ~64,301 total (63,300+ created) | Old UISP API → Python script | Running (ETA ~12:00 PM PHT Feb 11) |
| **Payments** | ~60,700 (linked to paid invoices) | Created alongside invoices | Running |
| **PPPoE Usernames** | ~9,912 | Old UISP API (planned) | Pending |
| **Sites & Devices** | N/A | Auto-generated by ROS plugin | Not needed |

---

## How Client ID Mapping Works

This is critical to understand for all data imports.

### The Problem

The old UISP and new UISP assign different `id` numbers to the same client:

```
Old UISP:  Client "Juan Dumaran"  →  id: 16560860
New UISP:  Client "Juan Dumaran"  →  id: 2670
```

Every import (invoices, payments, PPPoE, etc.) needs to map old IDs to new IDs.

### The Solution: `userIdent` Field

During the client import, the **old client ID was saved in the `userIdent` field** (labeled "Custom ID" in the UISP UI) on each client in the new UISP.

```
New UISP Client:
  id:         2670          ← new auto-generated ID
  userIdent:  "16560860"    ← old UISP client ID (stored for mapping)
  firstName:  "Juan Paulo"
  lastName:   "Dumaran"
```

### How Imports Use This Mapping

Every import script:
1. Fetches all clients from the **new** UISP
2. Reads each client's `userIdent` field (the old ID)
3. Builds a lookup table: `old_id → new_id`
4. When importing data (invoices, payments, etc.), translates the old `clientId` to the new one

```
Import flow for an invoice:
  Old invoice has clientId: 16560860
       ↓ lookup userIdent
  Found new client id: 2670
       ↓
  Create invoice under clientId: 2670 on new UISP
```

### Important: All Imported Data Uses New IDs

Once imported, invoices and payments are stored with **new UISP client IDs only**. The old IDs are not stored on invoices or payments — they were only used during the mapping step.

```
Example imported invoice on new UISP:
  Invoice #116252
  clientId: 12492       ← this is the NEW UISP id
  amount: ₱899.00
  status: 3 (paid)
```

### For Future Operations

After migration is complete, **no mapping is needed for new data**. The new UISP will generate invoices, payments, and all records using its own native IDs. The `userIdent` field can be kept as an audit trail or repurposed later.

---

## 1. Client Import (Completed)

**Script:** `scripts/import_clients.py`
**Task doc:** `.claude/tasks/uisp-csv-client-import.md`

### Summary

- Source: CSV export from old UISP
- 9,871 clients in CSV → 9,826 successfully imported
- 45 failed (36 blank names, 9 other issues)
- Old client ID saved in `userIdent` field for mapping

### What each client has

- Name, email, address, phone
- `userIdent` = old UISP client ID
- `note` = PPPoE username (if available)

---

## 2. Invoice Import (Running)

**Script:** `scripts/import_invoices.py`
**Task doc:** `.claude/tasks/uisp-invoice-import.md`

### Summary

- Source: Old UISP API (`GET /invoices`)
- 64,301 invoices exported to `scripts/invoices_export.json` (129.4 MB)
- Import creates both the invoice AND linked payment in one pass

### Invoice Status Distribution (from old UISP)

| Status | Count | What Happens |
|--------|-------|-------------|
| Paid (3) | 60,012 | Invoice created + Cash payment linked → status becomes "paid" |
| Unpaid (1) | 3,478 | Invoice created, no payment → status stays "unpaid" |
| Partially paid (2) | 688 | Invoice created + partial Cash payment linked |
| Void (4) | 122 | Skipped (not imported) |
| Draft (0) | 1 | Skipped (not imported) |

### How Invoice + Payment Creation Works

For each paid invoice, the script makes **two API calls**:

```
Step 1: POST /crm/api/v1.0/clients/{clientId}/invoices
  → Creates the invoice (starts as "unpaid")
  → Returns new invoice ID

Step 2: POST /crm/api/v1.0/payments
  → Creates a Cash payment linked to the invoice via "invoiceIds"
  → UISP automatically sets the invoice status to "paid"
```

### Key API Limitations Discovered

| Field | Limitation |
|-------|-----------|
| `dueDate` | Cannot be set directly — auto-calculated from `createdDate + maturityDays` |
| `status` | Cannot be set directly — derived from linked payments |
| `type` on line items | Always creates as "other" (cosmetic only, amounts are correct) |
| Payment method "Custom" | Requires `providerName` and `providerPaymentId` — not suitable for bulk import |

### Payment Method

All payments use **Cash** method (`6efe0fa8-36b2-4dd1-b049-427bffc7d369`). This was chosen because:
- No extra fields required (unlike "Custom" method)
- Works for bulk import
- Clearly identifies imported historical payments

### Skipped Invoices

~1,000 invoices are skipped because their client doesn't exist in the new UISP. These belong to the ~45 clients that failed during the original client import (blank names, etc.).

### Running / Resuming the Import

```bash
# Check progress (in tmux)
tmux attach -t invoice-import

# Check log file
cd /home/imperial/projects/imperial-investigation/scripts
ls -t import_invoices_*.log | head -1 | xargs tail -20

# Resume from a specific index if interrupted
python3 import_invoices.py --import-from invoices_export.json --resume-from 50000 --verbose

# Re-export from old UISP if needed (before Feb 15!)
python3 import_invoices.py --export-only
```

---

## 3. PPPoE Username Import (Pending)

**Task doc:** `.claude/tasks/uisp-pppoe-import.md`

### Summary

- Old UISP has 9,912 PPPoE usernames stored as **client-level** custom attributes (attribute id=1)
- New UISP has PPPoE as **service-level** custom attributes (attribute id=2) — required by ROS plugin
- Script needs to: fetch from old UISP → map client → find service → update service attribute
- **PPPoE passwords are NOT in old UISP** — must come from MikroTik later

### Status

Waiting for team confirmation before proceeding. Task documented and ready to build.

---

## 4. Sites & Devices — NOT Needed

### Why No Import Is Required

The old UISP had:
- 10,315 "endpoint" sites
- 10,218 devices (all type: `blackBox` / `UNKNOWN`)

These are **auto-generated subscriber endpoints**, not real infrastructure. They were created by the ROS plugin when PPPoE provisioning was set up. Only 2 actual "site" entries existed (both inactive test sites).

**Once PPPoE provisioning is configured on the new UISP with the production MikroTik router, sites and devices will auto-generate.**

---

## Architecture Diagram

```
OLD UISP (McBroad)                    NEW UISP (On-Premise)
uisp.imperial-networks.com            10.255.255.86
┌──────────────────────┐              ┌──────────────────────┐
│  Clients (10,113)    │──── CSV ────→│  Clients (9,826)     │
│  Invoices (64,301)   │──── API ────→│  Invoices (63,300+)  │
│  Payments            │  (linked)   →│  Payments (linked)   │
│  PPPoE usernames     │──── API ────→│  PPPoE (pending)     │
│  Sites (auto-gen)    │     ✗        │  Sites (auto-gen)    │
│  Devices (auto-gen)  │     ✗        │  Devices (auto-gen)  │
└──────────────────────┘              └──────────────────────┘
         │                                      │
    API access ends                     Production MikroTik
    Feb 15, 2026                        (to be connected)
                                               │
                                        ┌──────┴──────┐
                                        │  ROS Plugin  │
                                        │  auto-creates│
                                        │  sites +     │
                                        │  devices     │
                                        └─────────────┘
```

---

## File Locations

| File | Purpose |
|------|---------|
| `scripts/import_invoices.py` | Invoice + payment import script |
| `scripts/config.py` | API credentials (old + new UISP) — **DO NOT commit** |
| `scripts/invoices_export.json` | Exported invoices (129 MB) — **DO NOT commit** |
| `scripts/import_invoices_*.log` | Import log files |
| `.claude/tasks/uisp-csv-client-import.md` | Client import task doc |
| `.claude/tasks/uisp-invoice-import.md` | Invoice import task doc |
| `.claude/tasks/uisp-pppoe-import.md` | PPPoE import task doc |
| `.claude/tasks/uisp-payment-history-import.md` | Payment history task doc |

---

## Credentials

All API keys and credentials are stored in `scripts/config.py` (not committed to git).

| Credential | Config Variable | Notes |
|-----------|----------------|-------|
| New UISP API key | `UISP_API_TOKEN` | For `10.255.255.86` |
| Old UISP API key | `OLD_UISP_API_KEY` | For `uisp.imperial-networks.com` — expires Feb 15 |

---

## Timeline

| Date | Action |
|------|--------|
| Feb 8-9 | Client import from CSV (9,826 clients) |
| Feb 10 | Invoice export (64,301) + import started |
| Feb 11 | Invoice import running (~ETA 12:00 PM PHT) |
| Feb 11-14 | PPPoE import (pending team confirmation) |
| Feb 15 | **Old UISP access ends** |
| TBD | Connect production MikroTik → ROS plugin auto-creates sites/devices |

---

## Verification After Import

### Quick Checks

```bash
# Invoice count in new UISP
curl -sk "https://10.255.255.86/crm/api/v1.0/invoices?limit=1&offset=63000" \
  -H "X-Auth-App-Key: <API_TOKEN>"

# Payment count
sudo docker exec unms-postgres psql -U postgres -d unms -c \
  "SELECT COUNT(*) FROM ucrm.invoice;"

sudo docker exec unms-postgres psql -U postgres -d unms -c \
  "SELECT COUNT(*) FROM ucrm.payment;"
```

### Spot-Check Checklist

- [ ] Pick 5 random clients → verify their invoices appear in UISP UI
- [ ] Paid invoices show green "Paid" status
- [ ] Invoice amounts match old UISP
- [ ] Invoice dates match old UISP
- [ ] Client account balances look reasonable
- [ ] No duplicate invoices
