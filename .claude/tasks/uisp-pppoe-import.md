# Task: Import PPPoE Usernames from Old UISP into New UISP Services

**Date:** February 10, 2026
**Status:** ✅ Completed (Feb 11, 11:23 PHT) — 9,603 services updated, 0 failures
**Depends on:** `uisp-csv-client-import.md` (completed)

---

## Objective

Populate PPPoE username custom attributes on services in the new UISP instance by extracting data from the old McBroad UISP CRM API.

---

## Background

### What We Have

| Data | Status | Source |
|------|--------|--------|
| Clients (9,826) | ✅ Imported | CSV → API script |
| Payments (~59K) | ✅ Importing | Team via UISP UI |
| Invoices | ✅ Exporting | Team from old UISP |
| PPPoE usernames on services | ❌ Missing | Need to import |
| PPPoE passwords on services | ❌ Missing | Deferred — need production MikroTik |
| Sites & Devices | ❌ Not needed | Auto-generated by ROS plugin |

### Why PPPoE Usernames Matter

The ROS plugin (`ros-plugin v2.3.5`) manages PPPoE provisioning on MikroTik. It reads three custom attributes from each service:
- `pppoeusername` (id=2) — **this is what we're importing**
- `pppoepassword` (id=4) — deferred until production MikroTik connected
- `device` (id=3) — deferred until production MikroTik connected

---

## Sites & Devices Investigation Results

### Question: Can we get sites/devices from MikroTik?

**Answer: Not needed.** The old UISP's "sites" and "devices" are auto-generated, not real infrastructure:

| Data | Count | What It Actually Is | Import? |
|------|-------|---------------------|---------|
| Sites (endpoint type) | 10,315 | One per subscriber — auto-created by ROS plugin when PPPoE links to CRM | **No** — auto-regenerates |
| Sites (site type) | 2 | "test" and "My first site" — both inactive test entries | **No** — not useful |
| Devices | 10,218 | All "blackBox / UNKNOWN model" — PPPoE connections tracked as devices | **No** — auto-regenerates |

**Conclusion:** Once PPPoE provisioning is set up with the production MikroTik, the ROS plugin will automatically create endpoint sites and blackBox devices for each subscriber. No manual import needed.

### Old UISP API Access

We obtained API access to the old McBroad UISP:
- **URL:** `https://uisp.imperial-networks.com`
- **CRM API Token:** See `scripts/config.py` → `OLD_UISP_API_KEY` (user: dbojo)
- **NMS API:** Also works with same token via `x-auth-token` header
- **Access deadline:** February 15, 2026 (when McBroad access ends)

---

## Data Source: Old UISP CRM API

### Client Custom Attributes (Old UISP)

| Attribute | Key | Attribute ID | Count | Import? |
|-----------|-----|-------------|-------|---------|
| PPPOE Username | `pppoeUsername` | 1 | **9,912** clients | ✅ Yes |
| Address | `address` | 3 | 7,600 clients | Optional |
| Facility | `facility` | 2 | 11 clients | No |
| NOTE | `note` | 7 | 20 clients | No |

**Important:** On the old UISP, these are **client-level** attributes. On the new UISP, `pppoeusername` is a **service-level** attribute (as required by the ROS plugin).

### Total Clients in Old UISP

- Page 1 (offset 0): 10,000 clients
- Page 2 (offset 10000): 113 clients
- **Total: 10,113 clients** (vs 9,826 imported to new UISP — difference is the 45 failed + some new clients added after our CSV export)

### Sample Data

```
Client ID 16549813 → PPPoE: "0028quiniquinisanjamayor"
Client ID 16549818 → PPPoE: "blk5lot5fontana"
Client ID 16549820 → PPPoE: "blk5lot6STphase1"
Client ID 16549821 → PPPoE: "blk55lot6STphase1"
Client ID 16549822 → PPPoE: "blk27lot15STphase2"
```

---

## Implementation Plan

### Step 1: Export PPPoE Usernames from Old UISP

```
GET https://uisp.imperial-networks.com/crm/api/v1.0/clients?limit=10000
GET https://uisp.imperial-networks.com/crm/api/v1.0/clients?limit=10000&offset=10000
```

Extract `pppoeUsername` from each client's `attributes` array. Build mapping:
```python
{original_client_id: pppoe_username}
# e.g., {"16549813": "0028quiniquinisanjamayor", "16549818": "blk5lot5fontana", ...}
```

### Step 2: Build Client ID Mapping on New UISP

```
GET https://10.255.255.86/crm/api/v1.0/clients?limit=10000
```

Each client has `userIdent` = original client ID. Build mapping:
```python
{original_client_id: new_client_id}
# e.g., {"16549813": 2668, "16549818": 2669, ...}
```

### Step 3: Get Services from New UISP

```
GET https://10.255.255.86/crm/api/v1.0/clients/services?limit=10000
```

Build mapping:
```python
{new_client_id: service_id}
# e.g., {2668: 101, 2669: 102, ...}
```

### Step 4: Update Service Custom Attributes

For each service with a matching PPPoE username:
```
PATCH https://10.255.255.86/crm/api/v1.0/clients/services/{serviceId}

Body: {
    "attributes": [
        {"customAttributeId": 2, "value": "0028quiniquinisanjamayor"}
    ]
}
```

**Custom attribute IDs on new UISP (service-level):**
- id=2: `pppoeusername` ← **setting this now**
- id=3: `device` ← will set later (production router name)
- id=4: `pppoepassword` ← will set later (from MikroTik)

---

## Script Details

### Files

| File | Action | Purpose |
|------|--------|---------|
| `scripts/import_pppoe.py` | CREATE | Main PPPoE username import script |
| `scripts/config.py` | UPDATE | Add old UISP API credentials |

### Config Additions

```python
# Old UISP (McBroad)
OLD_UISP_BASE_URL = "https://uisp.imperial-networks.com"
OLD_UISP_API_KEY = "<see scripts/config.py>"
```

### Dependencies

No new dependencies — uses `requests` (already installed).

### Script Flow

```
1. Fetch all clients from OLD UISP (with pppoeUsername)
   → ~9,912 entries with PPPoE usernames

2. Fetch all clients from NEW UISP
   → Map userIdent → new client ID (~9,826 entries)

3. Fetch all services from NEW UISP
   → Map client ID → service ID (~9,771 entries)

4. For each matched client:
   a. original_id → pppoe_username (from old UISP)
   b. original_id → new_client_id (from new UISP via userIdent)
   c. new_client_id → service_id (from new UISP services)
   d. PATCH service with pppoeusername attribute
   e. Log result

5. Print summary
```

---

## Performance Estimate

- ~9,771 services to update
- At ~2-3 updates/second = **~1 hour**
- 3 bulk GET requests for data loading (a few seconds each)

---

## Verification Checklist

- [ ] Old UISP: PPPoE usernames extracted (~9,912 expected)
- [ ] Client ID mapping built (original → new UISP)
- [ ] Services matched to clients
- [ ] Test with 5 services first
- [ ] Run full update
- [ ] Spot-check 10 random services in UISP UI

---

## Future Work (Not This Task)

| Task | Depends On | Details |
|------|-----------|---------|
| Connect production MikroTik | Team to provide router details | Replace test router (main-ac at 10.86.0.23) |
| Import PPPoE passwords | Production MikroTik access | Extract from `/ppp/secret` or User Manager |
| Set device attribute | Production router name known | Update `device` (id=3) on all services |
| Verify ROS plugin sync | All above completed | Test suspend/unsuspend end-to-end |

---

## Useful Commands

```bash
# Check PPPoE username count from old UISP
curl -sk "https://uisp.imperial-networks.com/crm/api/v1.0/clients?limit=1" \
  -H "X-Auth-App-Key: <OLD_API_KEY from config.py>"

# Check custom attributes on new UISP
curl -sk "https://10.255.255.86/crm/api/v1.0/custom-attributes" \
  -H "X-Auth-App-Key: <API_TOKEN from config.py>"

# Check a specific service's attributes on new UISP
curl -sk "https://10.255.255.86/crm/api/v1.0/clients/services/{serviceId}" \
  -H "X-Auth-App-Key: <API_TOKEN from config.py>"

# Count services in new UISP
curl -sk "https://10.255.255.86/crm/api/v1.0/clients/services?limit=1" \
  -H "X-Auth-App-Key: <API_TOKEN from config.py>"
```

---

## Reference

- **Previous task:** `.claude/tasks/uisp-csv-client-import.md`
- **Payment task:** `.claude/tasks/uisp-payment-history-import.md`
- **New UISP API base:** `https://10.255.255.86/crm/api/v1.0`
- **Old UISP API base:** `https://uisp.imperial-networks.com/crm/api/v1.0`
- **Scripts directory:** `/home/imperial/projects/imperial-investigation/scripts/`
- **Old UISP access deadline:** February 15, 2026

---

## MikroTik Notes (For Future Reference)

When production MikroTik is connected, PPPoE passwords can be extracted via:

```python
# Using RouterOS-api library (pip install RouterOS-api)
import routeros_api
conn = routeros_api.RouterOsApiPool('ROUTER_IP', username='admin', password='...', port=8728)
api = conn.get_api()
secrets = api.get_resource('/ppp/secret').get()
# Each secret: {name, password, profile, remote-address, caller-id, disabled}
```

The team mentioned they use **MikroTik User Manager** — this is a centralized AAA system that may store PPPoE credentials differently from `/ppp/secret`. Will need to investigate which data source to use when the production router is available.
